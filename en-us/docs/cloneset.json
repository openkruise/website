{
  "filename": "cloneset.md",
  "__html": "<h1 id=\"cloneset\">CloneSet <a class=\"header-anchor\" href=\"#cloneset\">#</a></h1>\n<p>This controller provides advanced features to efficiently manage stateless applications that\ndo not have instance order requirement during scaling and rollout. Analogously,\nCloneSet can be recognized as an enhanced version of upstream <code>Deployment</code> workload, but it does many more.</p>\n<p>As name suggests, CloneSet is a <a href=\"../blog/blog1.html\"><strong>Set</strong> -suffix controller</a> which\nmanages Pods directly. A sample CloneSet yaml looks like following:</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">labels:</span>\n    <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">sample</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">sample</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">replicas:</span> <span class=\"hljs-number\">5</span>\n  <span class=\"hljs-attr\">selector:</span>\n    <span class=\"hljs-attr\">matchLabels:</span>\n      <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">sample</span>\n  <span class=\"hljs-attr\">template:</span>\n    <span class=\"hljs-attr\">metadata:</span>\n      <span class=\"hljs-attr\">labels:</span>\n        <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">sample</span>\n    <span class=\"hljs-attr\">spec:</span>\n      <span class=\"hljs-attr\">containers:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">nginx</span>\n        <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">nginx:alpine</span>\n</code></pre>\n<h2 id=\"scale-features\">Scale features <a class=\"header-anchor\" href=\"#scale-features\">#</a></h2>\n<h3 id=\"support-pvcs\">Support PVCs <a class=\"header-anchor\" href=\"#support-pvcs\">#</a></h3>\n<p>CloneSet allows user to define PVC templates <code>volumeClaimTemplates</code> in <code>CloneSetSpec</code>, which can support PVCs per Pod.\nThis cannot be done with <code>Deployment</code>. If not specified, CloneSet will only create Pods without PVCs.</p>\n<p>A few reminders:</p>\n<ul>\n<li>Each PVC created by CloneSet has an owner reference. So when a CloneSet has been deleted, its PVCs will be cascading deleted.</li>\n<li>Each Pod and PVC created by CloneSet has a &quot;<a href=\"http://apps.kruise.io/cloneset-instance-id\">apps.kruise.io/cloneset-instance-id</a>&quot; label key. They use the same string as label value which is composed of a unique  <strong>instance-id</strong> as suffix of the CloneSet name.</li>\n<li>When a Pod has been deleted by CloneSet controller, all PVCs related to it will be deleted together.</li>\n<li>When a Pod has been deleted manually, all PVCs related to the Pod are preserved, and CloneSet controller will create a new Pod with the same <strong>instance-id</strong> and reuse the PVCs.</li>\n<li>When a Pod is updated using <strong>recreate</strong> policy, all PVCs related to it will be deleted together.</li>\n<li>When a Pod is updated using <strong>in-place</strong> policy, all PVCs related to it are preserved.</li>\n</ul>\n<p>The following shows a sample CloneSet yaml file which contains PVC templates.</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">labels:</span>\n    <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">sample</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">sample-data</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">replicas:</span> <span class=\"hljs-number\">5</span>\n  <span class=\"hljs-attr\">selector:</span>\n    <span class=\"hljs-attr\">matchLabels:</span>\n      <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">sample</span>\n  <span class=\"hljs-attr\">template:</span>\n    <span class=\"hljs-attr\">metadata:</span>\n      <span class=\"hljs-attr\">labels:</span>\n        <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">sample</span>\n    <span class=\"hljs-attr\">spec:</span>\n      <span class=\"hljs-attr\">containers:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">nginx</span>\n        <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">nginx:alpine</span>\n        <span class=\"hljs-attr\">volumeMounts:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">data-vol</span>\n          <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/usr/share/nginx/html</span>\n  <span class=\"hljs-attr\">volumeClaimTemplates:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">metadata:</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">data-vol</span>\n      <span class=\"hljs-attr\">spec:</span>\n        <span class=\"hljs-attr\">accessModes:</span> <span class=\"hljs-string\">[</span> <span class=\"hljs-string\">\"ReadWriteOnce\"</span> <span class=\"hljs-string\">]</span>\n        <span class=\"hljs-attr\">resources:</span>\n          <span class=\"hljs-attr\">requests:</span>\n            <span class=\"hljs-attr\">storage:</span> <span class=\"hljs-string\">20Gi</span>\n</code></pre>\n<h3 id=\"selective-pod-deletion\">Selective Pod deletion <a class=\"header-anchor\" href=\"#selective-pod-deletion\">#</a></h3>\n<p>When a CloneSet is scaled down, sometimes user has preference to deleting specific Pods.\nThis cannot be done using <code>StatefulSet</code> or <code>Deployment</code>, because <code>StatefulSet</code> always delete Pod\nin order and <code>Deployment</code>/<code>ReplicaSet</code> only delete Pod by its own sorted sequence.</p>\n<p>CloneSet allows user to specify to-be-deleted Pod names when scaling down <code>replicas</code>. Take the following\nsample as an example,</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-comment\"># ...</span>\n  <span class=\"hljs-attr\">replicas:</span> <span class=\"hljs-number\">4</span>\n  <span class=\"hljs-attr\">scaleStrategy:</span>\n    <span class=\"hljs-attr\">podsToDelete:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">sample-9m4hp</span>\n</code></pre>\n<p>when controller receives above update request, it ensures the number of replicas to be 4. If some Pods needs to be\ndeleted, the Pods listed in <code>podsToDelete</code> will be deleted first.\nController will clear <code>podsToDelete</code> automatically once the listed Pods are deleted. Note that:</p>\n<ul>\n<li>If one just adds a Pod name to <code>podsToDelete</code> and do not modify <code>replicas</code>, controller will delete this Pod, and create a new Pod.</li>\n<li>Without specifying <code>podsToDelete</code>, controller will scale down by deleting Pods in the order: not-ready &lt; ready, unscheduled &lt; scheduled, and pending &lt; running.</li>\n</ul>\n<h2 id=\"update-features\">Update features <a class=\"header-anchor\" href=\"#update-features\">#</a></h2>\n<h3 id=\"in-place-update\">In-place update <a class=\"header-anchor\" href=\"#in-place-update\">#</a></h3>\n<p>CloneSet provides three update policies just like <code>AdvancedStatefulSet</code>, defaults to <code>ReCreate</code>.</p>\n<ul>\n<li><code>ReCreate</code>: controller will delete old Pods and PVCs and create new ones.</li>\n<li><code>InPlaceIfPossible</code>: controller will try to in-place update Pod instead of recreating them if possible. Currently, only <code>spec.template.metadata.*</code> and <code>spec.template.spec.containers[x].image</code> field can be in-place updated.</li>\n<li><code>InPlaceOnly</code>: controller will in-place update Pod instead of recreating them. With <code>InPlaceOnly</code> policy, user cannot modify any fields in <code>spec.template</code> other than <code>spec.template.spec.containers[x].image</code>.</li>\n</ul>\n<p>When a Pod being in-place update, controller will firstly update Pod status to make it become not-ready using readinessGate,\nand then update images in Pod spec to trigger Kubelet recreate the container on Node.\nHowever, sometimes Kubelet recreate containers so fast that other controllers such as endpoints-controller in kcm\nhave not noticed the Pod has turned to not-ready. This may lead to requests damaged.</p>\n<p>So we bring <strong>graceful period</strong> into in-place update. CloneSet has supported <code>gracePeriodSeconds</code>, which is a period\nduration between controller update pod status and update pod images.\nSo that endpoints-controller could have enough time to remove this Pod from endpoints.</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-comment\"># ...</span>\n  <span class=\"hljs-attr\">updateStrategy:</span>\n    <span class=\"hljs-attr\">type:</span> <span class=\"hljs-string\">InPlaceIfPossible</span>\n    <span class=\"hljs-attr\">inPlaceUpdateStrategy:</span>\n      <span class=\"hljs-attr\">gracePeriodSeconds:</span> <span class=\"hljs-number\">10</span>\n</code></pre>\n<h3 id=\"template-and-revision\">Template and revision <a class=\"header-anchor\" href=\"#template-and-revision\">#</a></h3>\n<p><code>spec.template</code> defines the latest pod template in the CloneSet.\nController will calculate a revision hash for each version of <code>spec.template</code> when it has been initialized or modified.\nFor example, when we create a sample CloneSet, controller will calculate the revision hash <code>sample-744d4796cc</code> and\npresent the hash in CloneSet Status.</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">generation:</span> <span class=\"hljs-number\">1</span>\n  <span class=\"hljs-comment\"># ...</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">replicas:</span> <span class=\"hljs-number\">5</span>\n  <span class=\"hljs-comment\"># ...</span>\n<span class=\"hljs-attr\">status:</span>\n  <span class=\"hljs-attr\">observedGeneration:</span> <span class=\"hljs-number\">1</span>\n  <span class=\"hljs-attr\">readyReplicas:</span> <span class=\"hljs-number\">5</span>\n  <span class=\"hljs-attr\">replicas:</span> <span class=\"hljs-number\">5</span>\n  <span class=\"hljs-attr\">updateRevision:</span> <span class=\"hljs-string\">sample-d4d4fb5bd</span>\n  <span class=\"hljs-attr\">updatedReadyReplicas:</span> <span class=\"hljs-number\">5</span>\n  <span class=\"hljs-attr\">updatedReplicas:</span> <span class=\"hljs-number\">5</span>\n  <span class=\"hljs-comment\"># ...</span>\n</code></pre>\n<p>Here are the explanations for the counters presented in CloneSet status:</p>\n<ul>\n<li><code>status.replicas</code>: Number of pods</li>\n<li><code>status.readyReplicas</code>: Number of <strong>ready</strong> pods</li>\n<li><code>status.availableReplicas</code>: Number of <strong>ready and available</strong> pods (satisfied with <code>minReadySeconds</code>)</li>\n<li><code>status.updateRevision</code>: Latest revision hash of this CloneSet</li>\n<li><code>status.updatedReplicas</code>: Number of pods with the latest revision</li>\n<li><code>status.updatedReadyReplicas</code>: Number of <strong>ready</strong> pods with the latest revision</li>\n</ul>\n<h3 id=\"partition\">Partition <a class=\"header-anchor\" href=\"#partition\">#</a></h3>\n<p>Partition is the <strong>desired number or percent of Pods in old revisions</strong>, defaults to <code>0</code>.  This field does <strong>NOT</strong> imply any update order.</p>\n<p>When <code>partition</code> is set during update:</p>\n<ul>\n<li>If it is a number: <code>(replicas - partition)</code> number of pods will be updated with the new version.</li>\n<li>If it is a percent: <code>(replicas * (100% - partition))</code> number of pods will be updated with the new version.</li>\n</ul>\n<p>For example, when we update sample CloneSet's container image to <code>nginx:mainline</code> and set <code>partition=3</code>, after a while, the sample CloneSet yaml looks like the following:</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-comment\"># ...</span>\n  <span class=\"hljs-attr\">generation:</span> <span class=\"hljs-number\">2</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">replicas:</span> <span class=\"hljs-number\">5</span>\n  <span class=\"hljs-attr\">template:</span>\n    <span class=\"hljs-attr\">metadata:</span>\n      <span class=\"hljs-attr\">labels:</span>\n        <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">sample</span>\n    <span class=\"hljs-attr\">spec:</span>\n      <span class=\"hljs-attr\">containers:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">nginx:mainline</span>\n        <span class=\"hljs-attr\">imagePullPolicy:</span> <span class=\"hljs-string\">Always</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">nginx</span>\n  <span class=\"hljs-attr\">updateStrategy:</span>\n    <span class=\"hljs-attr\">partition:</span> <span class=\"hljs-number\">3</span>\n  <span class=\"hljs-comment\"># ...</span>\n<span class=\"hljs-attr\">status:</span>\n  <span class=\"hljs-attr\">observedGeneration:</span> <span class=\"hljs-number\">2</span>\n  <span class=\"hljs-attr\">readyReplicas:</span> <span class=\"hljs-number\">5</span>\n  <span class=\"hljs-attr\">replicas:</span> <span class=\"hljs-number\">5</span>\n  <span class=\"hljs-attr\">updateRevision:</span> <span class=\"hljs-string\">sample-56dfb978d4</span>\n  <span class=\"hljs-attr\">updatedReadyReplicas:</span> <span class=\"hljs-number\">2</span>\n  <span class=\"hljs-attr\">updatedReplicas:</span> <span class=\"hljs-number\">2</span>\n</code></pre>\n<p>Note that <code>status.updateRevision</code> has been updated to <code>sample-56dfb978d4</code>, a new hash.\nSince we set <code>partition=3</code>, controller only updates two Pods to the latest revision.</p>\n<pre><code class=\"language-bash\">$ kubectl get pod -L controller-revision-hash\nNAME           READY   STATUS    RESTARTS   AGE     CONTROLLER-REVISION-HASH\nsample-chvnr   1/1     Running   0          6m46s   sample-d4d4fb5bd\nsample-j6c4s   1/1     Running   0          6m46s   sample-d4d4fb5bd\nsample-ns85c   1/1     Running   0          6m46s   sample-d4d4fb5bd\nsample-jnjdp   1/1     Running   0          10s     sample-56dfb978d4\nsample-qqglp   1/1     Running   0          18s     sample-56dfb978d4\n</code></pre>\n<h3 id=\"maxunavailable\">MaxUnavailable <a class=\"header-anchor\" href=\"#maxunavailable\">#</a></h3>\n<p>MaxUnavailable is the maximum number of Pods that can be unavailable during the update.\nValue can be an absolute number (e.g., 5) or a percentage of desired number of Pods (e.g., 10%).\nDefault value is 20%.</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-comment\"># ...</span>\n  <span class=\"hljs-attr\">updateStrategy:</span>\n    <span class=\"hljs-attr\">maxUnavailable:</span> <span class=\"hljs-number\">20</span><span class=\"hljs-string\">%</span>\n</code></pre>\n<h3 id=\"maxsurge\">MaxSurge <a class=\"header-anchor\" href=\"#maxsurge\">#</a></h3>\n<p>MaxSurge is the maximum number of pods that can be scheduled above the desired replicas during the update.\nValue can be an absolute number (ex: 5) or a percentage of desired pods (ex: 10%).\nDefaults to 0.</p>\n<p>If maxSurge is set somewhere, cloneset-controller will create <code>maxSurge</code> number of Pods above the <code>replicas</code>,\nwhen it finds multiple active revisions of Pods which means the CloneSet is in the update stage.\nAfter all Pods except <code>partition</code> number have been updated to the latest revision, <code>maxSurge</code> number Pods will be deleted,\nand the number of Pods will be equal to the <code>replica</code> number.</p>\n<p>What's more, maxSurge is forbidden to use with <code>InPlaceOnly</code> policy.\nWhen maxSurge is used with <code>InPlaceIfPossible</code>, controller will create additional Pods with latest revision first,\nand then update the rest Pods with old revisions,</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-comment\"># ...</span>\n  <span class=\"hljs-attr\">updateStrategy:</span>\n    <span class=\"hljs-attr\">maxSurge:</span> <span class=\"hljs-number\">3</span>\n</code></pre>\n<h3 id=\"update-sequence\">Update sequence <a class=\"header-anchor\" href=\"#update-sequence\">#</a></h3>\n<p>When controller chooses Pods to update, it has default sort logic based on Pod phase and conditions:\n<strong>unscheduled &lt; scheduled, pending &lt; unknown &lt; running, not-ready &lt; ready</strong>.\nIn addition, CloneSet also supports advanced <code>priority</code> and <code>scatter</code> strategies to allow users to specify the update order.</p>\n<h4 id=\"priority-strategy\"><code>priority</code> strategy <a class=\"header-anchor\" href=\"#priority-strategy\">#</a></h4>\n<p>This strategy defines rules for calculating the priority of updating pods.\nAll update candidates will be applied with the priority terms.\n<code>priority</code> can be calculated either by weight or by order.</p>\n<ul>\n<li><code>weight</code>: Priority is determined by the sum of weights for terms that match selector. For example,</li>\n</ul>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-comment\"># ...</span>\n  <span class=\"hljs-attr\">updateStrategy:</span>\n    <span class=\"hljs-attr\">priorityStrategy:</span>\n      <span class=\"hljs-attr\">weightPriority:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">weight:</span> <span class=\"hljs-number\">50</span>\n        <span class=\"hljs-attr\">matchSelector:</span>\n          <span class=\"hljs-attr\">matchLabels:</span>\n            <span class=\"hljs-attr\">test-key:</span> <span class=\"hljs-string\">foo</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">weight:</span> <span class=\"hljs-number\">30</span>\n        <span class=\"hljs-attr\">matchSelector:</span>\n          <span class=\"hljs-attr\">matchLabels:</span>\n            <span class=\"hljs-attr\">test-key:</span> <span class=\"hljs-string\">bar</span>\n</code></pre>\n<ul>\n<li><code>order</code>: Priority will be determined by the value of the orderKey. The update candidates are sorted based on the &quot;int&quot; part of the value string. For example, 5 in string &quot;5&quot; and 10 in string &quot;sts-10&quot;.</li>\n</ul>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-comment\"># ...</span>\n  <span class=\"hljs-attr\">updateStrategy:</span>\n    <span class=\"hljs-attr\">priorityStrategy:</span>\n      <span class=\"hljs-attr\">orderPriority:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">orderedKey:</span> <span class=\"hljs-string\">some-label-key</span>\n</code></pre>\n<h4 id=\"scatter-strategy\"><code>scatter</code> strategy <a class=\"header-anchor\" href=\"#scatter-strategy\">#</a></h4>\n<p>This strategy defines rules to make certain Pods be scattered during update.\nFor example, if a CloneSet has <code>replica=10</code>, and we add <code>foo=bar</code> label in 3 Pods and specify the following scatter rule. These 3 Pods will\nbe the 1st, 6th and 10th updated Pods.</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-comment\"># ...</span>\n  <span class=\"hljs-attr\">updateStrategy:</span>\n    <span class=\"hljs-attr\">scatterStrategy:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">foo</span>\n      <span class=\"hljs-attr\">value:</span> <span class=\"hljs-string\">bar</span>\n</code></pre>\n<p>Note that:</p>\n<ul>\n<li>Although <code>priority</code> strategy and <code>scatter</code> strategy can be applied together, we strongly suggest to just use one of them to avoid confusion.</li>\n<li>If <code>scatter</code> strategy is used, we suggest to just use one term. Otherwise, the update order can be hard to understand.</li>\n</ul>\n<p>Last but not the least, the above advanced update strategies require independent Pod labeling mechanisms, which are not provided by CloneSet.</p>\n<h3 id=\"paused-update\">Paused update <a class=\"header-anchor\" href=\"#paused-update\">#</a></h3>\n<p><code>paused</code> indicates that Pods updating is paused, controller will not update Pods but just maintain the number of replicas.</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-comment\"># ...</span>\n  <span class=\"hljs-attr\">updateStrategy:</span>\n    <span class=\"hljs-attr\">paused:</span> <span class=\"hljs-literal\">true</span>\n</code></pre>\n<h3 id=\"lifecycle-hook\">Lifecycle hook <a class=\"header-anchor\" href=\"#lifecycle-hook\">#</a></h3>\n<p>Since v0.6.1, kruise has supported lifecycle hook for CloneSet.</p>\n<p>Each Pod managed by CloneSet has a clear state defined in <code>lifecycle.apps.kruise.io/state</code> label:</p>\n<ul>\n<li>Normal</li>\n<li>PreparingUpdate</li>\n<li>Updating</li>\n<li>Updated</li>\n<li>PreparingDelete</li>\n</ul>\n<p>Lifecycle hook allows users to do something (for example remove pod from service endpoints) during Pod deleting and before/after in-place update.</p>\n<pre><code class=\"language-golang\"><span class=\"hljs-keyword\">type</span> LifecycleStateType <span class=\"hljs-keyword\">string</span>\n\n<span class=\"hljs-comment\">// Lifecycle contains the hooks for Pod lifecycle.</span>\n<span class=\"hljs-keyword\">type</span> Lifecycle <span class=\"hljs-keyword\">struct</span> {\n    <span class=\"hljs-comment\">// PreDelete is the hook before Pod to be deleted.</span>\n    PreDelete *LifecycleHook <span class=\"hljs-string\">`json:\"preDelete,omitempty\"`</span>\n    <span class=\"hljs-comment\">// InPlaceUpdate is the hook before Pod to update and after Pod has been updated.</span>\n    InPlaceUpdate *LifecycleHook <span class=\"hljs-string\">`json:\"inPlaceUpdate,omitempty\"`</span>\n}\n\n<span class=\"hljs-keyword\">type</span> LifecycleHook <span class=\"hljs-keyword\">struct</span> {\n    LabelsHandler     <span class=\"hljs-keyword\">map</span>[<span class=\"hljs-keyword\">string</span>]<span class=\"hljs-keyword\">string</span> <span class=\"hljs-string\">`json:\"labelsHandler,omitempty\"`</span>\n    FinalizersHandler []<span class=\"hljs-keyword\">string</span>          <span class=\"hljs-string\">`json:\"finalizersHandler,omitempty\"`</span>\n}\n</code></pre>\n<p>Examples:</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">spec:</span>\n\n  <span class=\"hljs-comment\"># define with finalizer</span>\n  <span class=\"hljs-attr\">lifecycle:</span>\n    <span class=\"hljs-attr\">preDelete:</span>\n      <span class=\"hljs-attr\">finalizersHandler:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">example.io/unready-blocker</span>\n    <span class=\"hljs-attr\">inPlaceUpdate:</span>\n      <span class=\"hljs-attr\">finalizersHandler:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">example.io/unready-blocker</span>\n\n  <span class=\"hljs-comment\"># or define with label</span>\n  <span class=\"hljs-attr\">lifecycle:</span>\n    <span class=\"hljs-attr\">inPlaceUpdate:</span>\n      <span class=\"hljs-attr\">labelsHandler:</span>\n        <span class=\"hljs-attr\">example.io/block-unready:</span> <span class=\"hljs-string\">\"true\"</span>\n</code></pre>\n<h4 id=\"state-circulation\">State circulation <a class=\"header-anchor\" href=\"#state-circulation\">#</a></h4>\n<p><img src=\"/img/docs/cloneset-lifecycle.png\" alt=\"Lifecycle circulation\"></p>\n<ul>\n<li>When CloneSet delete a Pod (including scale in and recreate update):\n<ul>\n<li>Delete it directly if no lifecycle hook definition or Pod not matched preDelete hook</li>\n<li>Otherwise, CloneSet will firstly update Pod to <code>PreparingDelete</code> state and wait for user controller to remove the label/finalizer and Pod not matched preDelete hook</li>\n<li>Note that Pods in <code>PreparingDelete</code> state will not be updated</li>\n</ul>\n</li>\n<li>When CloneSet update a Pod in-place:\n<ul>\n<li>If lifecycle hook defined and Pod matched inPlaceUpdate hook, CloneSet will update Pod to <code>PreparingUpdate</code> state</li>\n<li>After user controller remove the label/finalizer (thus Pod not matched inPlaceUpdate hook), CloneSet will update it to <code>Updating</code> state and start updating</li>\n<li>After in-place update completed, CloneSet will update Pod to <code>Updated</code> state if lifecycle hook defined and Pod not matched inPlaceUpdate hook</li>\n<li>When user controller add label/finalizer into Pod and it matched inPlaceUpdate hook, CloneSet will finally update it to <code>Normal</code> state</li>\n</ul>\n</li>\n</ul>\n<p>Besides, although our design supports to change a Pod from <code>PreparingDelete</code> back to <code>Normal</code> (through cancel specified delete), but it is not recommended. Because Pods in <code>PreparingDelete</code> state will not be updated by CloneSet, it might be updating immediately if comes back to <code>Normal</code>. This case is hard for user controller to handle.</p>\n<h4 id=\"another-way-for-specified-delete\">Another way for specified delete <a class=\"header-anchor\" href=\"#another-way-for-specified-delete\">#</a></h4>\n<p>As we introduced above, CloneSet has <code>spec.scaleStrategy.podsToDelete</code> field and allow users to specify some Pods when reduce replicas.</p>\n<p>But if user just want to delete a Pod and let CloneSet create a new one, we provides another Pod label for specified delete: <code>apps.kruise.io/specified-delete: true</code>.\nPods with this label, CloneSet will update it to <code>PreparingDelete</code> state, and delete it after hook has been satisfied.</p>\n<h4 id=\"example-for-user-controller-logic\">Example for user controller logic <a class=\"header-anchor\" href=\"#example-for-user-controller-logic\">#</a></h4>\n<p>Same as yaml example above, we can fisrtly defineï¼š</p>\n<ul>\n<li><code>example.io/unready-blocker</code> finalizer as hook</li>\n<li><code>example.io/initialing</code> annotation as identity for initializing</li>\n</ul>\n<p>Add these fields into CloneSet template:</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">template:</span>\n    <span class=\"hljs-attr\">metadata:</span>\n      <span class=\"hljs-attr\">annotations:</span>\n        <span class=\"hljs-attr\">example.io/initialing:</span> <span class=\"hljs-string\">\"true\"</span>\n      <span class=\"hljs-attr\">finalizers:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">example.io/unready-blocker</span>\n  <span class=\"hljs-comment\"># ...</span>\n  <span class=\"hljs-attr\">lifecycle:</span>\n    <span class=\"hljs-attr\">preDelete:</span>\n      <span class=\"hljs-attr\">finalizersHandler:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">example.io/unready-blocker</span>\n    <span class=\"hljs-attr\">inPlaceUpdate:</span>\n      <span class=\"hljs-attr\">finalizersHandler:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">example.io/unready-blocker</span>\n</code></pre>\n<p>User controller logic:</p>\n<ul>\n<li>For Pod in <code>Normal</code> state, if there is <code>example.io/initialing: true</code> in annotation and ready condition in Pod status is True, then add it to endpoints and remove the annotation</li>\n<li>For Pod in <code>PreparingDelete</code> and <code>PreparingUpdate</code> states, delete it from endpoints and remove <code>example.io/unready-blocker</code> finalizer</li>\n<li>For Pod in <code>Updated</code> state, add it to endpoints and add <code>example.io/unready-blocker</code> finalizer</li>\n</ul>\n",
  "link": "/en-us/docs/cloneset.html",
  "meta": {
    "title": "CloneSet"
  }
}