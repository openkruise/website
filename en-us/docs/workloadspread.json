{
  "filename": "workloadspread.md",
  "__html": "<h1 id=\"workloadspread\">WorkloadSpread <a class=\"header-anchor\" href=\"#workloadspread\">#</a></h1>\n<p><strong>FEATURE STATE:</strong> Kruise v0.10.0</p>\n<p>WorkloadSpread can distribute Pods of workload to different types of Node according to some polices, which empowers single workload the abilities for\nmulti-domain deployment and elastic deployment.</p>\n<p>Some common policies include:</p>\n<ul>\n<li>fault toleration spread (for example, spread evenly among hosts, az, etc)</li>\n<li>spread according to the specified ratio (for example, deploy Pod to several specified az according to the proportion)</li>\n<li>subset management with priority, such as\n<ul>\n<li>deploy Pods to ecs first, and then deploy to eci when its resources are insufficient.</li>\n<li>deploy a fixed number of Pods to ecs first, and the rest Pods are deployed to eci.</li>\n</ul>\n</li>\n<li>subset management with customization, such as\n<ul>\n<li>control how many pods in a workload are deployed in different cpu arch</li>\n<li>enable pods in different cpu arch to have different resource requirements</li>\n</ul>\n</li>\n</ul>\n<p>The feature of WorkloadSpread is similar with UnitedDeployment in OpenKruise community. Each WorkloadSpread defines multi-domain\ncalled <code>subset</code>. Each domain may provide the limit to run the replicas number of pods called <code>maxReplicas</code>.\nWorkloadSpread injects the domain configuration into the Pod by Webhook, and it also controls the order of scale in and scale out.</p>\n<p>Currently, supported workload: <code>CloneSet</code>、<code>Deployment</code>、<code>ReplicaSet</code>.</p>\n<h2 id=\"workloadspread-demo\">WorkloadSpread Demo <a class=\"header-anchor\" href=\"#workloadspread-demo\">#</a></h2>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">WorkloadSpread</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">workloadspread-demo</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">targetRef:</span>\n    <span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps/v1</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n    <span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Deployment</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">CloneSet</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">workload-xxx</span>\n  <span class=\"hljs-attr\">subsets:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">subset-a</span>\n      <span class=\"hljs-attr\">requiredNodeSelectorTerm:</span>\n        <span class=\"hljs-attr\">matchExpressions:</span>\n          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">topology.kubernetes.io/zone</span>\n            <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">In</span>\n            <span class=\"hljs-attr\">values:</span>\n              <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">zone-a</span>\n    <span class=\"hljs-attr\">preferredNodeSelectorTerms:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">weight:</span> <span class=\"hljs-number\">1</span>\n        <span class=\"hljs-attr\">preference:</span>\n        <span class=\"hljs-attr\">matchExpressions:</span>\n          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">another-node-label-key</span>\n            <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">In</span>\n            <span class=\"hljs-attr\">values:</span>\n              <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">another-node-label-value</span>\n      <span class=\"hljs-attr\">maxReplicas:</span> <span class=\"hljs-number\">3</span>\n      <span class=\"hljs-attr\">tolertions:</span> <span class=\"hljs-string\">[]</span>\n      <span class=\"hljs-attr\">patch:</span>\n        <span class=\"hljs-attr\">metadata:</span>\n          <span class=\"hljs-attr\">labels:</span>\n            <span class=\"hljs-attr\">xxx-specific-label:</span> <span class=\"hljs-string\">xxx</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">subset-b</span>\n      <span class=\"hljs-attr\">requiredNodeSelectorTerm:</span>\n        <span class=\"hljs-attr\">matchExpressions:</span>\n          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">topology.kubernetes.io/zone</span>\n            <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">In</span>\n            <span class=\"hljs-attr\">values:</span>\n              <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">zone-b</span>\n  <span class=\"hljs-attr\">scheduleStrategy:</span>\n    <span class=\"hljs-attr\">type:</span> <span class=\"hljs-string\">Adaptive</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">Fixed</span>\n    <span class=\"hljs-attr\">adaptive:</span>\n      <span class=\"hljs-attr\">rescheduleCriticalSeconds:</span> <span class=\"hljs-number\">30</span>\n</code></pre>\n<p><code>targetRef</code>: specify the target workload. Can not be mutated，and one workload can only correspond to one WorkloadSpread.</p>\n<h2 id=\"spec.subsets\">spec.subsets <a class=\"header-anchor\" href=\"#spec.subsets\">#</a></h2>\n<p><code>subsets</code> consists of multiple domain called <code>subset</code>, and each topology has different configuration.</p>\n<h3 id=\"subset-sub-fields\">subset sub-fields <a class=\"header-anchor\" href=\"#subset-sub-fields\">#</a></h3>\n<ul>\n<li>\n<p><code>name</code>: the name of <code>subset</code>, it is distinct in a WorkloadSpread, which represents a topology.</p>\n</li>\n<li>\n<p><code>maxReplicas</code>：the replicas limit of <code>subset</code>, and must be Integer and &gt;= 0. There is no replicas limit while the <code>maxReplicas</code> is nil.</p>\n</li>\n</ul>\n<blockquote>\n<p>Don't support percentage type in current version.</p>\n</blockquote>\n<ul>\n<li>\n<p><code>requiredNodeSelectorTerm</code>: match zone hardly。</p>\n</li>\n<li>\n<p><code>preferredNodeSelectorTerms</code>: match zone softly。</p>\n</li>\n</ul>\n<p><strong>Caution</strong>：<code>requiredNodeSelectorTerm</code> corresponds the <code>requiredDuringSchedulingIgnoredDuringExecution</code> of nodeAffinity.\n<code>preferredNodeSelectorTerms</code> corresponds the <code>preferredDuringSchedulingIgnoredDuringExecution</code> of nodeAffinity.</p>\n<ul>\n<li><code>tolerations</code>: the tolerations of Pod in <code>subset</code>.</li>\n</ul>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">tolerations:</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">\"key1\"</span>\n  <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">\"Equal\"</span>\n  <span class=\"hljs-attr\">value:</span> <span class=\"hljs-string\">\"value1\"</span>\n  <span class=\"hljs-attr\">effect:</span> <span class=\"hljs-string\">\"NoSchedule\"</span>\n</code></pre>\n<ul>\n<li><code>patch</code>: customize the Pod configuration of <code>subset</code>, such as Annotations, Labels, Env.</li>\n</ul>\n<p>Example:</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-comment\"># patch pod with a topology label:</span>\n<span class=\"hljs-attr\">patch:</span>\n  <span class=\"hljs-attr\">metadata:</span>\n    <span class=\"hljs-attr\">labels:</span>\n      <span class=\"hljs-attr\">topology.application.deploy/zone:</span> <span class=\"hljs-string\">\"zone-a\"</span>\n</code></pre>\n<pre><code class=\"language-yaml\"><span class=\"hljs-comment\"># patch pod container resources:</span>\n<span class=\"hljs-attr\">patch:</span>\n  <span class=\"hljs-attr\">spec:</span>\n    <span class=\"hljs-attr\">containers:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">main</span>\n      <span class=\"hljs-attr\">resources:</span>\n        <span class=\"hljs-attr\">limit:</span>\n          <span class=\"hljs-attr\">cpu:</span> <span class=\"hljs-string\">\"2\"</span>\n          <span class=\"hljs-attr\">memory:</span> <span class=\"hljs-string\">800Mi</span>\n</code></pre>\n<pre><code class=\"language-yaml\"><span class=\"hljs-comment\"># patch pod container env with a zone name:</span>\n<span class=\"hljs-attr\">patch:</span>\n  <span class=\"hljs-attr\">spec:</span>\n    <span class=\"hljs-attr\">containers:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">main</span>\n      <span class=\"hljs-attr\">env:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">K8S_AZ_NAME</span>\n        <span class=\"hljs-attr\">value:</span> <span class=\"hljs-string\">zone-a</span>\n</code></pre>\n<h2 id=\"schedule-strategy\">Schedule strategy <a class=\"header-anchor\" href=\"#schedule-strategy\">#</a></h2>\n<p>WorkloadSpread provides two kind strategies, the default strategy is <code>Fixed</code>.</p>\n<h3 id=\"fixed%3A\">Fixed: <a class=\"header-anchor\" href=\"#fixed%3A\">#</a></h3>\n<p>Workload is strictly spread according to the definition of the subset.</p>\n<h3 id=\"adaptive\">Adaptive <a class=\"header-anchor\" href=\"#adaptive\">#</a></h3>\n<p><strong>Reschedule</strong>: Kruise will check the unschedulable Pods of subset. If it exceeds the defined duration, the failed Pods will be rescheduled to the other <code>subset</code>.</p>\n<h2 id=\"required\">Required <a class=\"header-anchor\" href=\"#required\">#</a></h2>\n<h3 id=\"pod-webhook\">Pod Webhook <a class=\"header-anchor\" href=\"#pod-webhook\">#</a></h3>\n<p>WorkloadSpread uses <code>webhook</code> to inject fault domain rules.</p>\n<p>If the <code>PodWebhook</code> feature-gate is set to false, WorkloadSpread will also be disabled.</p>\n<h3 id=\"deletion-cost-feature\">deletion-cost feature <a class=\"header-anchor\" href=\"#deletion-cost-feature\">#</a></h3>\n<p><code>CloneSet</code> has supported deletion-cost feature in the latest versions.</p>\n<p>The other native workload need kubernetes version &gt;= 1.21. (In 1.21, users need to enable PodDeletionCost feature-gate, and since 1.22 it will be enabled by default)</p>\n<h2 id=\"scale-order%3A\">Scale order: <a class=\"header-anchor\" href=\"#scale-order%3A\">#</a></h2>\n<p>The workload managed by WorkloadSpread will scale according to the defined order in <code>spec.subsets</code>.</p>\n<p><strong>The order of <code>subset</code> in <code>spec.subsets</code> can be changed</strong>, which can adjust the scale order of workload.</p>\n<h3 id=\"scale-out\">Scale out <a class=\"header-anchor\" href=\"#scale-out\">#</a></h3>\n<ul>\n<li>The Pods are scheduled in the subset order defined in the <code>spec.subsets</code>. It will be scheduled in the next <code>subset</code> while the replica number reaches the maxReplicas of <code>subset</code></li>\n</ul>\n<h3 id=\"scale-in\">Scale in <a class=\"header-anchor\" href=\"#scale-in\">#</a></h3>\n<ul>\n<li>When the replica number of the <code>subset</code> is greater than the <code>maxReplicas</code>, the extra Pods will be removed in a high priority.</li>\n<li>According to the <code>subset</code> order in the <code>spec.subsets</code>, the Pods of the <code>subset</code> at the back are deleted before the Pods at the front.</li>\n</ul>\n<pre><code class=\"language-yaml\"><span class=\"hljs-comment\">#             subset-a   subset-b  subset-c</span>\n<span class=\"hljs-comment\"># maxReplicas    10          10        nil</span>\n<span class=\"hljs-comment\"># pods number    10          10        10</span>\n<span class=\"hljs-comment\"># deletion order: c -&gt; b -&gt; a</span>\n\n<span class=\"hljs-comment\">#             subset-a   subset-b  subset-c</span>\n<span class=\"hljs-comment\"># maxReplicas    10          10        nil</span>\n<span class=\"hljs-comment\"># pods number    20          20        20</span>\n<span class=\"hljs-comment\"># deletion order: b -&gt; a -&gt; c</span>\n</code></pre>\n<h2 id=\"feature-gates\">feature-gates <a class=\"header-anchor\" href=\"#feature-gates\">#</a></h2>\n<p>WorkloadSpread feature is turned off by default, if you want to turn it on set feature-gates <em>WorkloadSpread</em>.</p>\n<pre><code class=\"language-bash\">$ helm install kruise https://... --<span class=\"hljs-built_in\">set</span> featureGates=<span class=\"hljs-string\">\"WorkloadSpread=true\"</span>\n</code></pre>\n<h2 id=\"example\">Example <a class=\"header-anchor\" href=\"#example\">#</a></h2>\n<h3 id=\"elastic-deployment\">Elastic deployment <a class=\"header-anchor\" href=\"#elastic-deployment\">#</a></h3>\n<p><code>zone-a</code>(ACK) holds 100 Pods, <code>zone-b</code>(ECI) as an elastic zone holds additional Pods.</p>\n<ol>\n<li>Create a WorkloadSpread instance.</li>\n</ol>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">WorkloadSpread</span>\n<span class=\"hljs-attr\">metadta:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ws-demo</span>\n  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">deploy</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">targetRef:</span> <span class=\"hljs-comment\"># workload in the same namespace</span>\n    <span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n    <span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">workload-xxx</span>\n  <span class=\"hljs-attr\">subsets:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ACK</span> <span class=\"hljs-comment\"># zone ACK</span>\n    <span class=\"hljs-attr\">requiredNodeSelectorTerm:</span>\n      <span class=\"hljs-attr\">matchExpressions:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">topology.kubernetes.io/zone</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">In</span>\n        <span class=\"hljs-attr\">values:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">ack</span>\n    <span class=\"hljs-attr\">maxReplicas:</span> <span class=\"hljs-number\">100</span>\n    <span class=\"hljs-attr\">patch:</span> <span class=\"hljs-comment\"># inject label.</span>\n      <span class=\"hljs-attr\">metadata:</span>\n        <span class=\"hljs-attr\">labels:</span>\n          <span class=\"hljs-attr\">deploy/zone:</span> <span class=\"hljs-string\">ack</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ECI</span> <span class=\"hljs-comment\"># zone ECI</span>\n    <span class=\"hljs-attr\">requiredNodeSelectorTerm:</span>\n      <span class=\"hljs-attr\">matchExpressions:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">topology.kubernetes.io/zone</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">In</span>\n        <span class=\"hljs-attr\">values:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">eci</span>\n    <span class=\"hljs-attr\">patch:</span>\n      <span class=\"hljs-attr\">metadata:</span>\n        <span class=\"hljs-attr\">labels:</span>\n          <span class=\"hljs-attr\">deploy/zone:</span> <span class=\"hljs-string\">eci</span>\n</code></pre>\n<ol start=\"2\">\n<li>Creat a corresponding workload, the number of replicas ca be adjusted freely.</li>\n</ol>\n<h4 id=\"effect\">Effect <a class=\"header-anchor\" href=\"#effect\">#</a></h4>\n<ul>\n<li>When the number of <code>replicas</code> &lt;= 100, the Pods are scheduled in <code>ACK</code> zone.</li>\n<li>When the number of <code>replicas</code> &gt; 100, the 100 Pods are in <code>ACK</code> zone, the extra Pods are scheduled in <code>ECI</code> zone.</li>\n<li>The Pods in <code>ECI</code> elastic zone are removed first when scaling in.</li>\n</ul>\n<h3 id=\"multi-domain-deployment\">Multi-domain deployment <a class=\"header-anchor\" href=\"#multi-domain-deployment\">#</a></h3>\n<p>Deploy 100 Pods to two <code>zone</code>(zone-a, zone-b) separately.</p>\n<ol>\n<li>Create a WorkloadSpread instance.</li>\n</ol>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">WorkloadSpread</span>\n<span class=\"hljs-attr\">metadta:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ws-demo</span>\n  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">deploy</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">targetRef:</span>\n    <span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps.kruise.io/v1alpha1</span>\n    <span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">CloneSet</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">workload-xxx</span>\n  <span class=\"hljs-attr\">subsets:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">subset-a</span>\n    <span class=\"hljs-attr\">requiredNodeSelectorTerm:</span>\n      <span class=\"hljs-attr\">matchExpressions:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">topology.kubernetes.io/zone</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">In</span>\n        <span class=\"hljs-attr\">values:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">zone-a</span>\n    <span class=\"hljs-attr\">maxReplicas:</span> <span class=\"hljs-number\">100</span>\n    <span class=\"hljs-attr\">patch:</span>\n      <span class=\"hljs-attr\">metadata:</span>\n        <span class=\"hljs-attr\">labels:</span>\n          <span class=\"hljs-attr\">deploy/zone:</span> <span class=\"hljs-string\">zone-a</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">subset-b</span>\n    <span class=\"hljs-attr\">requiredNodeSelectorTerm:</span>\n      <span class=\"hljs-attr\">matchExpressions:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">topology.kubernetes.io/zone</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">In</span>\n        <span class=\"hljs-attr\">values:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">zone-b</span>\n    <span class=\"hljs-attr\">maxReplicas:</span> <span class=\"hljs-number\">100</span>\n    <span class=\"hljs-attr\">patch:</span>\n      <span class=\"hljs-attr\">metadata:</span>\n        <span class=\"hljs-attr\">labels:</span>\n          <span class=\"hljs-attr\">deploy/zone:</span> <span class=\"hljs-string\">zone-b</span>\n</code></pre>\n<ol start=\"2\">\n<li>\n<p>Creat a corresponding workload with a 200 replicas, or perform a rolling update on an existing workload.</p>\n</li>\n<li>\n<p>If the spread of zone needs to be changed, first adjust the <code>maxReplicas</code> of <code>subset</code>, and then change the <code>replicas</code> of workload.</p>\n</li>\n</ol>\n",
  "link": "/en-us/docs/workloadspread.html",
  "meta": {
    "title": "WorkloadSpread"
  }
}